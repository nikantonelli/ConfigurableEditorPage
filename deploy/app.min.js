Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){return text=a.responseText,CHECKSUM&&CHECKSUM!==c._generateChecksum(text)?void b.resolve(!1):void b.resolve(!0)}}),b.promise},afterRender:function(){var a=Rally.getApp();a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})}}),this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml}),this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"This app was created by the Rally Technical Services Team."}),APP_BUILD_DATE&&this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"Build date/time: "+APP_BUILD_DATE})}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("Rally.technicalservices.AttachmentEditor",{extend:"Ext.panel.Panel",alias:"widget.tsattachmenteditor",height:200,width:"100%",record:void 0,constructor:function(a){this.mergeConfig(a),this.callParent([this.config])},initComponent:function(){this.callParent(arguments),this._store=Ext.create("Ext.data.Store",{fields:["filename","content","description","contentType"],data:[]}),this.add({xtype:"rallygrid",columnCfgs:this._getColumnCfgs(),showPagingToolbar:!1,showRowActionsColumn:!1,store:this._store,emptyText:"No Attachments",hideHeaders:!0}),this.add({xtype:"filebutton",text:"Upload",margin:10,cls:"secondary rly-small",listeners:{change:this.addFile,scope:this}})},addFile:function(a,b,c){var d=this,e=a.fileInputEl.dom.files[0],f=e.name||c.split(/\/|\\/).pop(),g=e.type&&e.type.length>0?e.type:"text/plain",h=new FileReader;console.log("readAsBinaryString",a,e),h.onload=function(a){console.log("f onload",h.result);var b=window.btoa(h.result);console.log("f onload",b),d._store.add({filename:f,description:"",content:b,contentType:g})},h.readAsBinaryString(e)},removeFile:function(a,b,c){var d=a.getStore().getAt(b);this._store.remove(d)},_getColumnCfgs:function(){var a=this;return[{xtype:"actioncolumn",width:40,items:[{icon:"/slm/js-lib/rui/builds/rui/resources/css/images/trash-icon.png",tooltip:"Remove file",scope:a,handler:a.removeFile}]},{dataIndex:"filename",text:"File",flex:1,editor:{xtype:"filefield",buttonConfig:{cls:"rly-small secondary"}},renderer:function(a,b,c){return null==a?"Click to Add...":a}},{dataIndex:"name",text:"Name"},{dataIndex:"description",text:"Description"}]},getValue:function(){return this._store.data.items}}),function(){function a(a,b,c){return e.widget(e.apply({xtype:"rallyfieldvaluecombobox",name:a.name,value:b.get(a.name),field:a,labelAlign:"right",labelWidth:Rally.technicalservices.DetailEditorFactory.labelWidth,labelCls:Rally.technicalservices.DetailEditorFactory.labelCls,width:"75%",minWidth:200,editable:!1,allowNoEntry:g(a,b),useNullForNoEntryValue:!0,plugins:[{xclass:"Rally.ui.detail.plugins.LoadingMonitor"}]},c))}function b(a){var b=e.create("Rally.data.wsapi.Filter",{property:"State",operator:"!=",value:"Accepted"});return a&&_.isString(a._refObjectName)&&(b=b.or(e.create("Rally.data.wsapi.Filter",{property:"Name",operator:"=",value:a._refObjectName}))),b}function c(a,b,c){return e.create("Rally.ui.detail.view.MilestonesField",{field:a,record:b,readOnly:c})}function d(){return 25}var e=window.Ext4||window.Ext,f=function(a,b,c){var d=Rally.data.util.Record.getProject(b),f=b.get(a.name);return _.isObject(f)&&(f=f._ref),c&&b.phantom&&!f&&(f=Rally.environment.getContext().getUser()._ref,b.set(a.name,f)),e.create("Rally.ui.combobox.UserSearchComboBox",{project:d,name:a.name,value:f,bubbleEvents:["select"],triggerWrapCls:"fullwidth",plugins:[{xclass:"Rally.ui.detail.plugins.LoadingMonitor"}]})},g=function(a,b){return!a.required||!b.get(a.name)};e.define("Rally.technicalservices.DetailEditorFactory",{requires:["Rally.data.util.Record","Rally.data.wsapi.Filter","Rally.ui.combobox.FieldValueComboBox","Rally.ui.detail.DetailHelper","Rally.ui.detail.view.DetailWebLinkField","Rally.ui.detail.view.DetailNumberField","Rally.ui.detail.view.StateField","Rally.ui.detail.view.DetailReadOnlyRefreshingField","Rally.ui.detail.view.ReadyButton","Rally.ui.renderer.template.progressbar.PercentDoneByStoryCountTemplate","Rally.ui.renderer.template.progressbar.PercentDoneByStoryPlanEstimateTemplate","Rally.ui.popover.PercentDonePopover","Rally.ui.detail.view.MilestonesField","Rally.util.Ref","Rally.ui.combobox.ProjectComboBox"],singleton:!0,labelWidth:150,labelCls:"tslabel",controlWidth:"90%",padding:0,getEditor:function(a,b,c,d,e){var f;return f=this.fieldEditors[a.name]?this.fieldEditors[a.name](a,b):a.attributeDefinition&&this.typeEditors[a.attributeDefinition.AttributeType.toLowerCase()]?this.getEditorByType(a,b):this.defaultRenderer(a,b),f.addCls("detailFieldEditor"),f.itemId=c,f.fieldLabel=e,f.margin=d,f.labelAlign="right",f},getEditorByType:function(a,b){return this.typeEditors[a.attributeDefinition.AttributeType.toLowerCase()](a,b)},defaultRenderer:function(a,b){return this.typeEditors.string(a,b)},fieldEditors:{Attachments:function(a,b){return e.create("Rally.technicalservices.AttachmentEditor",{record:b,title:a.displayName})},Iteration:function(a,c){var d=c.get(a.name);return e.create("Rally.ui.combobox.IterationComboBox",{name:a.name,value:d,allowNoEntry:g(a,c),showArrows:!1,defaultSelectionToFirst:!0,defaultToCurrentTimebox:!1,labelAlign:"right",storeConfig:{remoteFilter:!0,filters:[b(d)],context:{project:Rally.data.util.Record.getProject(c),projectScopeUp:!1,projectScopeDown:!1}},plugins:[{xclass:"Rally.ui.detail.plugins.LoadingMonitor"}]})},Milestones:function(a,b){var d=!Rally.ui.detail.DetailHelper.isDetailPageFieldEditable(a,b);return c(a,b,d)},Owner:function(a,b){return f(a,b,b.isUserStory())},Release:function(a,c){var d=c.get(a.name);return e.create("Rally.ui.combobox.ReleaseComboBox",{name:a.name,value:d,allowNoEntry:g(a,c),showArrows:!1,defaultSelectionPosition:"first",defaultToCurrentTimebox:!1,labelAlign:"right",storeConfig:{remoteFilter:!0,filters:[b(d)],context:{project:Rally.data.util.Record.getProject(c),projectScopeUp:!1,projectScopeDown:!1}},plugins:[{xclass:"Rally.ui.detail.plugins.LoadingMonitor"}]})}},typeEditors:{"boolean":function(a,b){var c=e.create("Ext.data.Store",{fields:["value","display"],data:[{value:!0,display:"Yes"},{value:!1,display:"No"}]});return e.create("Rally.ui.combobox.ComboBox",{name:a.displayName,store:c,queryMode:"local",displayField:"display",valueField:"value",width:"25%",minWidth:200,labelAlign:"right",labelWidth:Rally.technicalservices.DetailEditorFactory.labelWidth,labelCls:Rally.technicalservices.DetailEditorFactory.labelCls,value:b.get(a.name),defaultSelectionPosition:"last"})},date:function(a,b){return e.create("Rally.ui.DateField",{format:Rally.util.DateTime.getUserExtDateFormat(),validateOnChange:!1,name:a.displayName,value:b.get(a.name),width:"25%",minWidth:200,labelAlign:"right",labelWidth:Rally.technicalservices.DetailEditorFactory.labelWidth,labelCls:Rally.technicalservices.DetailEditorFactory.labelCls})},decimal:function(a,b){var c=Number(b.get(a.name))||0;return e.create("Rally.ui.NumberField",{name:a.displayName,displayName:a.displayName,value:c,labelAlign:"right",height:d(),field:a,hideTrigger:!0,width:"25%",labelSeparator:"",minWidth:200,labelAlign:"right",labelWidth:Rally.technicalservices.DetailEditorFactory.labelWidth,labelCls:Rally.technicalservices.DetailEditorFactory.labelCls,padding:Rally.technicalservices.DetailEditorFactory.padding})},integer:function(a,b){var c=Number(b.get(a.name))||0;return e.create("Rally.ui.NumberField",{name:a.displayName,displayName:a.displayName,value:c,labelAlign:"right",height:d(),field:a,hideTrigger:!0,width:"25%",labelSeparator:"",minWidth:200,labelAlign:"right",labelWidth:Rally.technicalservices.DetailEditorFactory.labelWidth,labelCls:Rally.technicalservices.DetailEditorFactory.labelCls,padding:Rally.technicalservices.DetailEditorFactory.padding})},object:function(a,b){return a.attributeDefinition.Constrained?e.create("Rally.ui.combobox.ComboBox",{name:a.displayName,value:b.get(a.name),editable:!1,labelWidth:Rally.technicalservices.DetailEditorFactory.labelWidth,labelCls:Rally.technicalservices.DetailEditorFactory.labelCls,labelAlign:"right",storeConfig:{autoLoad:!0,model:a.attributeDefinition.SchemaType,initialValue:b.get(a.name)?b.get(a.name)._refObjectName:""},allowNoEntry:g(a,b)}):e.create("Rally.ui.TextField",{name:a.displayName,value:b.get(a.name),labelWidth:Rally.technicalservices.DetailEditorFactory.labelWidth,labelCls:Rally.technicalservices.DetailEditorFactory.labelCls,padding:Rally.technicalservices.DetailEditorFactory.padding,labelAlign:"right"})},quantity:function(a,b){var c=Number(b.get(a.name))||0;return e.create("Rally.ui.NumberField",{name:a.displayName,displayName:a.displayName,value:c,labelAlign:"right",height:d(),field:a,width:"25%",labelSeparator:"",minWidth:200,labelAlign:"right",labelWidth:Rally.technicalservices.DetailEditorFactory.labelWidth,labelCls:Rally.technicalservices.DetailEditorFactory.labelCls,padding:Rally.technicalservices.DetailEditorFactory.padding})},rating:function(b,c){return b.attributeDefinition.Constrained?a(b,c,{allowNoEntry:!b.required||"None"===c.get(b.name),ratingNoEntryString:"-- No Entry --",noEntryValue:"None",labelAlign:"right",useNullForNoEntryValue:!1}):e.create("Rally.ui.TextField",{name:b.displayName,value:c.get(b.name),width:"25%",minWidth:200,labelAlign:"right",labelWidth:Rally.technicalservices.DetailEditorFactory.labelWidth,labelCls:Rally.technicalservices.DetailEditorFactory.labelCls,padding:Rally.technicalservices.DetailEditorFactory.padding})},string:function(b,c){return b.attributeDefinition.Constrained?a(b,c):e.create("Rally.ui.TextField",{name:b.name,value:c.get(b.name),height:d(),minWidth:200,labelSeparator:"",labelWidth:Rally.technicalservices.DetailEditorFactory.labelWidth,labelCls:Rally.technicalservices.DetailEditorFactory.labelCls,width:Rally.technicalservices.DetailEditorFactory.controlWidth,padding:Rally.technicalservices.DetailEditorFactory.padding})},text:function(a,b){var c,d=Rally.ui.detail.DetailHelper.isDetailPageFieldEditable(a,b);return c=d?e.create("Rally.technicalservices.RichTextEditor",{field:a,record:b,labelAlign:"right",padding:Rally.technicalservices.DetailEditorFactory.padding}):e.create("Rally.ui.richtext.RichTextEditorReadOnly",{html:b.get(a.name)}),Rally.ui.detail.DetailHelper.getController()&&Rally.ui.detail.DetailHelper.getController().on("recordupdate",function(b){c.setValue(b.get(a.name))}),c},web_link:function(a,b){return e.create("Rally.ui.detail.view.DetailWebLinkField",{field:a,record:b})}}})}(),Ext.define("Rally.technicalservices.RichTextEditor",{extend:"Ext.Container",layout:{type:"hbox"},width:Rally.technicalservices.DetailEditorFactory.controlWidth,alias:"widget.tsrichtexteditor",height:200,constructor:function(a){this.mergeConfig(a),this.callParent([this.config])},initComponent:function(){this.callParent(arguments);var a=this.record,b=this.field;this.add({xtype:"container",html:Ext.String.format('<div class="tslabel">{0}</div>',b.name),width:Rally.technicalservices.DetailEditorFactory.labelWidth,padding:5});var c=Ext.create("Rally.ui.richtext.RichTextEditor",{field:b,record:a,title:b.name,itemId:"rt-editor",margin:5,name:b.name,value:a.get(b.name),growToFitContent:!0,allowImageUpload:!0,renderTpl:'<div class="richTextToolbar"></div><div class="richTextContent"></div>',EDITOR_MIN_HEIGHT:110,toolbarAlwaysEnabled:!1,showUndoButton:!0,disableUndoButtonWithToolbar:!1,indicatorFoldUnder:!0,useLinkBubble:!0,flex:1,listeners:{focus:function(){var a=Ext.ComponentQuery.query("rallydetailfieldcontaineredpcomplete[focused=true]")[0];if(a){var b=a.editor;b!==this&&(a.clearSelection(),b.hasFocus=!1,b.fireEvent("blur"),b.collapse&&b.collapse())}},blur:function(){var a=Ext.ComponentQuery.query("rallydetailfieldcontaineredpcomplete"),b=_.find(a,function(a){return a.editor?a.editor.hasFocus:void 0},this);b&&b.focusField()},imageuploaded:function(a){var b=Rally.ui.detail.DetailHelper.getController();b&&b._handleImageUpload(a)}}});c.on("boxready",this._resize,this),Rally.ui.detail.DetailHelper.getController()&&Rally.ui.detail.DetailHelper.getController().on("recordupdate",function(a){c.setValue(a.get(b.name))}),this.add(c)},_resize:function(){this.down("#rt-editor").setHeight(this.height)},getValue:function(){return this.down("#rt-editor").getValue()},validator:function(a){return!0},validate:function(){var a=this.validator(this.down("#rt-editor").getValue());return a===!0?!0:(Ext.create("Rally.ui.tooltip.ToolTip",{target:this.down("#rt-editor").getEl(),html:'<div class="tsinvalid">'+a+"</div>",autoShow:!0,destroyAfterHide:!0}),!1)}}),Ext.define("Rally.technicalservices.DynamicCellEditor",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsdynamiceditor",autoShow:!0,draggable:!0,closable:!0,modal:!0,title:"Dialog Example",items:[],cls:"bulk-edit-dialog",width:300,config:{record:null},initComponent:function(){this.callParent(arguments),this.addEvents("edit");var a=this._getEditor(this.record);this.record.get("defaultValue")&&this.record.get("defaultValue").length>0&&(a.value=this.record.get("defaultValue")||null),this.add(a),this.addDocked({xtype:"toolbar",dock:"bottom",padding:"0 0 10 0",layout:{type:"hbox",pack:"center"},ui:"footer",items:[{xtype:"rallybutton",itemId:"applyButton",text:"Apply",cls:"primary rly-small",handler:this._onApplyClicked,scope:this},{xtype:"rallybutton",text:"Cancel",cls:"secondary rly-small",handler:function(){this.close()},scope:this}]})},_getEditor:function(a){var b=a.get("fieldName");this.title="Default Value for "+a.get("displayName");var c=a.get("fieldObj"),d={xtype:"textarea",itemId:"default",style:{width:"95%","float":"center"}};if(c&&c.attributeDefinition){if("STRING"===c.attributeDefinition.AttributeType&&c.attributeDefinition.Constrained===!0&&(d.xtype="rallyfieldvaluecombobox",d.model="PortfolioItem/Feature",d.field=b),"BOOLEAN"===c.attributeDefinition.AttributeType){var e=c.editor;return e.itemId="default",e}"QUANTITY"===c.attributeDefinition.AttributeType&&(d.xtype="rallynumberfield",d.minValue=0),"OBJECT"===c.attributeDefinition.AttributeType&&(d.xtype=c.editor.field.xtype)}return d},_onApplyClicked:function(){var a=this.down("#default");this.record.get("defaultValue")!==a.getValue()&&(this.record.set("defaultValue",a.getValue()),a.displayField&&a.getRecord()?this.record.set("defaultDisplayValue",a.getRecord().get(a.displayField)||a.getValue()):this.record.set("defaultDisplayValue",a.getValue())),this.close()}}),Ext.define("Rally.technicalservices.BooleanFieldComboBox",{extend:"Rally.ui.combobox.FieldComboBox",alias:"widget.tsbooleanfieldcombobox",_isNotHidden:function(a){return!a.hidden&&a.attributeDefinition&&"BOOLEAN"==a.attributeDefinition.AttributeType}}),Ext.define("Rally.technicalservices.settings.FormConfiguration",{extend:"Ext.form.field.Base",alias:"widget.tsformconfigsettings",logger:new Rally.technicalservices.Logger,config:{value:void 0,fields:void 0,decodedValue:{}},fieldSubTpl:'<div id="{id}" class="settings-grid"></div>',noDefaultValue:["Attachments"],width:"100%",cls:"column-settings",onDestroy:function(){this._grid&&(this._grid.destroy(),delete this._grid),this.callParent(arguments)},onRender:function(){var a={};this.value&&!_.isEmpty(this.value)&&(a=Ext.JSON.decode(this.value)),this.callParent(arguments);var b=[];_.each(this.fields,function(a){b.push({order:a.order,fieldName:a.fieldName,displayName:a.displayName,display:a.display,defaultValue:a.defaultValue,required:a.required})},this),this._store=Ext.create("Ext.data.Store",{fields:["order","fieldName","displayName","display","defaultValue","required","fieldObj"],data:b,sortOnFilter:!1,sortOnLoad:!0,sorters:[{property:"order",value:"ASC"}]}),this._grid=Ext.create("Rally.ui.grid.Grid",{autoWidth:!0,renderTo:this.inputEl,columnCfgs:this._getColumnCfgs(),showPagingToolbar:!1,showRowActionsColumn:!1,store:this._store,height:400,width:.9*this.getWidth(),editingConfig:{publishMessages:!1},viewConfig:{plugins:{ptype:"gridviewdragdrop",dragText:"Drag and drop to reorder"}}})},_getColumnCfgs:function(){var a=this,b=[{text:"Field",dataIndex:"displayName",flex:1},{text:"Show",dataIndex:"display",renderer:function(a){return a===!0?"Yes":"No"},editor:{xtype:"rallycombobox",displayField:"name",valueField:"value",editable:!1,storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name","value"],data:[{name:"Yes",value:!0},{name:"No",value:!1}]}}},{text:"Required",dataIndex:"required",renderer:function(a){return a===!0?"Yes":"No"},editor:{xtype:"rallycombobox",displayField:"name",valueField:"value",editable:!1,storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name","value"],data:[{name:"Yes",value:!0},{name:"No",value:!1}]}}},{text:"Default Value",flex:3,xtype:"actioncolumn",sortable:!1,menuDisabled:!0,renderer:function(b,c,d){var e="<i>Default Values not Supported</i>",f="gray";return a._isAllowedDefaultValue(d)&&(e=d.get("defaultValue")||"",f="black"),Ext.String.format('<span style="display: inline; font-size: 11px; padding-left:50px;line-height:15px;color:{0};">{1}</span>',f,e)},items:[{icon:"/slm/images/icon_edit_view.gif",tooltip:"Edit",handler:function(b,c,d){var e=b.getStore().getAt(c);a.showEditor(e)},isDisabled:function(b,c,d,e,f){return!a._isAllowedDefaultValue(f)}},{icon:"/slm/images/icon_delete.gif",tooltip:"Delete",handler:function(a,b,c){var d=a.getStore().getAt(b);d.set("defaultValue",null)},isDisabled:function(b,c,d,e,f){return!a._isAllowedDefaultValue(f)}}]}];return b},_isAllowedDefaultValue:function(a){var b=["Attachments"];return Ext.Array.contains(b,a.get("fieldName"))?!1:!0},showEditor:function(a){Ext.create("Rally.technicalservices.DynamicCellEditor",{record:a,context:Rally.getApp().getContext()})},getSubmitData:function(){var a={};return a[this.name]=Ext.JSON.encode(this._buildSettingValue()),a},_buildSettingValue:function(){var a={},b=0;return this._store.each(function(c){a[c.get("fieldName")]={display:c.get("display"),displayName:c.get("displayName"),fieldName:c.get("fieldName"),defaultValue:c.get("defaultValue"),required:c.get("required"),order:b++}},this),a},getErrors:function(){var a=[];return _.isEmpty(this._buildSettingValue())&&a.push("At least one field must be shown."),a},validate:function(){var a=this,b=a.isValid();if(b!==a.wasValid&&(a.wasValid=b,a.fireEvent("validitychange",a,b)),!b){var c=this.getErrors().join("<br/>");Ext.create("Rally.ui.tooltip.ToolTip",{target:this.getEl(),html:'<div class="tsinvalid">'+c+"</div>",autoShow:!0,anchor:"bottom",destroyAfterHide:!0})}return b},setValue:function(a){this.callParent(arguments),this._value=a}}),Ext.define("Rally.technicalservices.RequestForm",{extend:"Ext.panel.Panel",alias:"widget.tsrequestform",logger:new Rally.technicalservices.Logger,layout:{type:"vbox"},config:{title:"",instructions:"These are instructions for filling out this form",model:void 0,formConfiguration:void 0,thankYouMessage:"Thank you for your submission.",submitDirectory:""},newRecord:null,constructor:function(a){this.mergeConfig(a),this.callParent(arguments)},initComponent:function(){this.callParent(),this.addEvents("save","ready","onwarning","onerror"),this._build(this.model)},_build:function(a){this.newRecord=this._getNewRecord(a),this._addInstructions(this.instructions),this._addFields(this.newRecord)},_addInstructions:function(){var a=this.add(Ext.create("Ext.container.Container",{tpl:'<tpl><div class="tsinstructions">{instructions}</div></tpl>'}));a.update(this)},_addFields:function(a){var b=this.model;if(_.isEmpty(this.formConfiguration)){var c="No fields were loaded to display.  Please check the configuration settings to verify that fields are configured for this App.";this.add({xtype:"container",html:c})}else _.each(this.formConfiguration,function(c,d){var e=b.getField(d);if(e&&c.display){var f=d,g=10,h=e.displayName,i=Rally.technicalservices.DetailEditorFactory.getEditor(e,a,f,g,h);i.labelCls="tslabel",c.required&&(i.validator=function(a){return Ext.isEmpty(a)||null==a||""==a?Ext.String.format("{0} is required.",d):!0}),i.msgTarget="side",i.on("boxready",this._resize,this),this.add(i)}},this),this.doLayout(),this.fireEvent("ready",this)},_resize:function(a){this.doLayout()},_getNewRecord:function(a){var b={};Ext.Object.each(this.formConfiguration,function(a,c){c.defaultValue&&(b[a]=c.defaultValue)},this),b.Owner=Rally.getApp().getContext().getUser()._ref,b.Project=this.submitDirectory;var c=Ext.create(a,b);return c},_updateNewRecord:function(){var a=["Attachments"],b=!0;return _.each(this.formConfiguration,function(c,d){if(!Ext.Array.contains(a,d)&&c.display){var e=this.down("#"+d).getValue()||c.defaultValue||null;if(b=this.down("#"+d).validate(),!b)return!1;this.newRecord.set(d,e)}},this),this.newRecord.get("Ready")&&this.submitDirectory&&this.newRecord.set("Project",this.submitDirectory),b},save:function(){if(!this._updateNewRecord())return!1;var a=null;this.down("#Attachments")&&(a=this.down("#Attachments").getValue()||null),this.newRecord.save({scope:this,callback:function(b,c){if(c.wasSuccessful())a?this._updateAttachments(b,"Attachments",a).then({scope:this,success:function(){this.fireEvent("save",b)},failure:function(a){this.fireEvent("save",b),this.fireEvent("onerror",{message:a})}}):this.fireEvent("save",b);else{var d=Ext.String.format("Submission could not be saved: {0}",c.error.errors[0]);this.fireEvent("onerror",{message:d})}}})},_updateAttachments:function(a,b,c){var d=Ext.create("Deft.Deferred"),e=this,f=[];return _.each(c,function(b){var c=function(){e._updateAttachment(a,b)};f.push(c)}),Deft.Chain.sequence(f).then({success:function(){d.resolve()},failure:function(a){d.reject(a)}}),d},_updateAttachment:function(a,b){var c=Ext.create("Deft.Deferred"),d=this;return Rally.data.ModelFactory.getModel({type:"AttachmentContent",success:function(e){var f=Ext.create(e,{Content:b.get("content")});f.save({callback:function(e,f){d.logger.log("_updateAttachment AttachmentContent.save callback",e,f),f.wasSuccessful()?Rally.data.ModelFactory.getModel({type:"Attachment",success:function(f){d.logger.log("_updateAttachment Attachment.model callback",f);var g=Ext.create(f,{Content:e.get("ObjectID"),ContentType:b.get("contentType"),Name:b.get("filename"),Artifact:a.get("_ref")});g.save({callback:function(a,b){b.wasSuccessful()?(d.logger.log("_updateAttachment Attachment.save callback",a,b),c.resolve()):c.reject("Error saving Attachment:  "+b.error&&b.error.errors.join(","))}})}}):c.reject("Unable to save content: "+f.error.errors.join(","))}})}}),c}}),Ext.define("Rally.technicalservices.WsapiToolbox",{singleton:!0,fetchModel:function(a){var b=Ext.create("Deft.Deferred");return Rally.data.wsapi.ModelFactory.getModel({type:a,success:function(a){b.resolve(a)},failure:function(){b.reject("Error loading model: "+a)}}),b.promise}}),Ext.define("configurable-request-form",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},config:{defaultSettings:{formConfigurationSettings:{},formInstructions:"",approvalField:!1,enableFormattedID:!1,submitDirectory:""}},formModel:void 0,formModelName:"PortfolioItem/Feature",items:[],notAllowedFields:["ScheduleState","PortfolioItem","State","Children","Parent","PredecessorsAndSuccessors","Predecessors","Successors","Project","Milestones","Workspace","Tags","Changesets","DisplayColor"],externalAppSettingsKey:"niksAppSettings",launch:function(){this.isExternal()?this.getExternalAppSettings(this.externalAppSettingsKey):this.onSettingsUpdate(this.getSettings())},_prepareApp:function(){Rally.technicalservices.WsapiToolbox.fetchModel(this.formModelName).then({scope:this,success:function(a){this.formModel=a,this._validateSettings(a)},failure:function(a){Rally.ui.notify.Notifier.showError({message:a})}})},_validateSettings:function(a){var b=this.formConfiguration;if(!Ext.isObject(b)){var c=this.getSetting("formConfigurationSettings");Ext.isObject(c)||(b=Ext.JSON.decode(c))}_.isEmpty(b)?this.add({xtype:"container",itemId:"display_box",flex:1,html:"No form configuration has been defined.<br/>Please use the App Settings to configure the form.",style:{fontFamily:"ProximaNovaLight, Helvetica, Arial"}}):(this.formConfiguration=b,this.model=a,this._showGrid(a))},_buildForm:function(a,b){this._clearWindow(),this.add({xtype:"container",itemId:"display_box",flex:1}),this.add({xtype:"container",itemId:"button_box",flex:1,layout:{type:"hbox",pack:"center"}}),this.down("#display_box").add({xtype:"tsrequestform",itemId:"requestform",model:a,instructions:this.formInstructions,formConfiguration:b,submitDirectory:this.submitDirectory,listeners:{scope:this,save:this._onSaved,onwarning:this._onWarning,onerror:this._onError,ready:this._onReady}}),this.down("#button_box").add({xtype:"rallybutton",text:"Submit",itemId:"btn-submit",style:{textAlign:"center"},width:75,scope:this,handler:this._save}),this.down("#button_box").add({xtype:"rallybutton",text:"Cancel",itemId:"btn-cancel",style:{textAlign:"center"},width:75,scope:this,handler:this._cancel})},_save:function(){var a=this.down("#requestform");a.save()},_onSaved:function(a){Rally.ui.notify.Notifier.showCreate({artifact:a}),this._showGrid(this.model)},_cancel:function(){this._showGrid(this.model)},_onWarning:function(a){Rally.ui.notify.Notifier.showWarning(a)},_onError:function(a){Rally.ui.notify.Notifier.showError(a)},_onReady:function(a){a.doLayout(),a.setWidth("95%"),this.down("#display_box").doLayout()},_clearWindow:function(){this.down("#story-grid")&&this.down("#story-grid").destroy(),this.down("#display_box")&&this.down("#display_box").destroy(),this.down("#button_box")&&this.down("#button_box").destroy(),this.down("#new_button")&&this.down("#new_button").destroy()},_checkSubmit:function(a,b,c,d){d.includes("Ready")&&"edit"===c&&b.raw.Ready===!1&&this.submitDirectory&&(b.set("Project",this.submitDirectory),this.fireEvent("update"))},_showGrid:function(a){this._clearWindow();var b=Ext.create("Ext.Container",{itemId:"new_button",items:[{xtype:"rallybutton",text:"New Request",margin:5,bubbleEvents:["click"]}]});this.add(b),b.on({click:this._onNewRequest,scope:this});var c=this.getContext(),d=Ext.create("Rally.data.wsapi.Store",{model:a,autoLoad:!1,fetch:!0,filters:[{property:"State.Name",operator:"!=",value:"Done"},{property:"Owner",value:c.getUser().UserName}],sorters:[{property:"CreationDate",direction:"DESC"}],listeners:{update:this._checkSubmit,scope:this}},this);d.load().then({scope:this,failure:function(a,b,c,d,e){},success:function(){this.add({xtype:"rallygrid",context:c,itemId:"story-grid",model:a,stateful:!1,store:d,showRowActionsColumn:!1,columnCfgs:this.getColumnCfgs(),height:this.getHeight()})},scope:this})},getColumnCfgs:function(){this.isExternal()?config_obj=Ext.JSON.decode(this.formConfigurationSettings):config_obj=Ext.JSON.decode(this.getSetting("formConfigurationSettings"));var a={};for(key in config_obj)config_obj[key].display&&(a[key]=config_obj[key]);var b=[];return b=this.getSetting("enableFormattedID")?["FormattedID"]:[{dataIndex:"FormattedID",text:"ID",renderer:function(a){return a}}],this.getSetting("approvalField")&&b.push({dataIndex:"Project",text:"Approval Stage",renderer:function(a){return a._refObjectName}}),b=b.concat(Ext.Object.getKeys(a))},_onNewRequest:function(){this._buildForm(this.model,this.formConfiguration)},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_isFieldAllowed:function(a){var b=["WEB_LINK"];return Ext.Array.contains(this.notAllowedFields,a.name)?!1:a.readOnly===!0||a.hidden===!0?!1:a&&!a.attributeDefinition?!1:Ext.Array.contains(b,a.attributeDefinition.AttributeType)?!1:!0},getSettingsFields:function(){var a=this.formModel,b={},c={};if(c=this.isExternal()?this.formConfigurationSettings:this.getSetting("formConfigurationSettings"),_.isEmpty(c)){if(a){modelFields=a.getFields();var d=1;_.each(modelFields,function(a){if(this._isFieldAllowed(a)){var c=a.required||!1,e=a.defaultValue||"",f=a.required||!1;b[a.name]={displayName:a.displayName,fieldName:a.name,display:c,defaultValue:e,required:f,order:d++}}},this)}}else b=Ext.JSON.decode(c);var e=[{name:"formInstructions",xtype:"textareafield",fieldLabel:"Form Instructions",labelAlign:"top",autoShow:!0,width:"100%",margin:15,height:100},{name:"formConfigurationSettings",xtype:"tsformconfigsettings",fieldLabel:'Drag rows to specify order on the form. Remember to "leave" the field for it to store!',margin:15,labelAlign:"top",fields:b},{name:"enableFormattedID",xtype:"rallycheckboxfield",fieldLabel:"Show ID as hyperlink",labelAlign:"top"},{name:"approvalField",xtype:"rallycheckboxfield",fieldLabel:"Show project node as approval stage",labelAlign:"top"},{name:"submitDirectory",xtype:"rallyprojectscopefield",labelAlign:"top",fieldLabel:'Target "submit on ready" project'}];return e},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()},onSettingsUpdate:function(a){Ext.apply(this,a),this.isExternal()?(this.saveExternalAppSettings(this.externalAppSettingsKey,a),this.formConfiguration=Ext.JSON.decode(a.formConfigurationSettings)):this.saveInternalAppSettings(),this._prepareApp()},saveExternalAppSettings:function(a,b){var c={};_.each(b,function(b,d){var e=a+"."+d;c[e]=b}),Rally.data.PreferenceManager.update({project:this.getContext().getProject()._ref,settings:c,scope:this,success:function(a,b){}})},getExternalAppSettings:function(a){Rally.data.PreferenceManager.load({project:this.getContext().getProject()._ref,additionalFilters:[{property:"name",operator:"contains",value:a}],scope:this,cache:!1,success:function(a){_.each(a,function(a,b){/\.formInstructions$/.test(b)&&(this.formInstructions=a),/\.formConfigurationSettings$/.test(b)&&a&&!_.isEmpty(a)&&(this.formConfigurationSettings=a)},this),this.formConfiguration=Ext.JSON.decode(this.formConfigurationSettings),this._prepareApp()}})},getInternalAppSettings:function(){this.formConfiguration=Ext.JSON.decode(this.formConfigurationSettings)},saveInternalAppSettings:function(){this.setSettings()}});